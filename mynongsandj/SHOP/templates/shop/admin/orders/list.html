{% extends "shop/admin/base_admin.html" %}
{% load static %}
{% block title %}Đơn hàng · Admin{% endblock %}
{% block page_title %}Đơn hàng{% endblock %}

{% block content %}
<style>
  html, body {height:100%; overflow:hidden;}
  .admin-fixed {height:calc(100vh - 0px); display:flex; flex-direction:column; overflow:hidden;}
  .toolbar-tight {margin-bottom:.5rem!important;}
  .card-body-tight {padding:.5rem 1rem!important;}
  .table-flex {flex:1 1 auto; min-height:0; overflow:hidden;}

  /* Search bar */
  .searchbar { --h: 38px; flex:1 1 auto; }
  .searchbar .inputbox {position:relative; flex:1 1 auto; min-width:300px;}
  .searchbar .inputbox .icon {
    position:absolute; left:12px; top:50%; transform:translateY(-50%);
    opacity:.65; color:#6c757d;
  }
  .searchbar .inputbox input.form-control {
    height:var(--h); padding-left:38px; padding-right:40px;
    border-radius:12px; border:1px solid rgba(0,0,0,.08);
    box-shadow:0 6px 18px rgba(30,60,120,.06);
  }
  .searchbar .inputbox .btn-clear {
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    border:none; background:transparent; opacity:.5;
  }
  .searchbar .btn-find {
    height:var(--h);
    background:linear-gradient(180deg,#4f8cff 0%,#3b78ff 100%);
    color:#fff; border:none; font-weight:600; border-radius:12px;
    padding:.35rem .9rem; box-shadow:0 8px 16px rgba(60,120,240,.18);
    transition:transform .08s ease,filter .2s ease;
  }
  .searchbar .btn-find:hover {filter:brightness(1.04); transform:translateY(-1px);}
  .btn-reset {border-radius:12px; height:var(--h); margin-left:8px;}

  /* Sticky pagination */
  .pagination-fixed {
    position:sticky; bottom:0; background:#fff;
    border-top:1px solid rgba(0,0,0,.05); padding:.5rem .75rem;
    display:flex; justify-content:flex-start; align-items:center;
  }
  .pagination-fixed .pagination {gap:4px; margin-bottom:0;}
  .pagination-fixed .page-link {
    min-width:34px; height:34px; padding:.25rem .6rem;
    text-align:center; line-height:1.5; border-radius:50% !important;
    color:#495057; border:none; background:#f8f9fa;
    box-shadow:0 2px 6px rgba(0,0,0,.05); transition:all .2s ease;
  }
  .pagination-fixed .page-link:hover {background:#4f8cff; color:#fff;}
  .pagination-fixed .page-item.active .page-link {
    background:#3b78ff; color:#fff; box-shadow:0 4px 12px rgba(60,120,240,.25);
  }
  .pagination-fixed .page-item.disabled .page-link {opacity:.5; pointer-events:none; background:#f1f1f1;}

  /* Toast top-right */
  .toast-container {position:fixed; top:16px; right:16px; z-index:1080; display:flex; flex-direction:column; gap:8px; pointer-events:none;}
  .toast {min-width:220px; max-width:320px; background:#059669; color:#fff; padding:.6rem .9rem; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.2); opacity:0; transform:translateY(-10px); transition:all .3s ease; pointer-events:auto;}
  .toast.show {opacity:1; transform:translateY(0);}
  .messages, .django-messages, .alert {display:none!important;}
</style>

<div class="admin-fixed">

  <!-- Toolbar -->
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 toolbar-tight">
  <form id="searchForm" class="d-flex searchbar" method="get" action="" style="min-width:560px">
    <div class="inputbox me-2">
      <i class="bi bi-search icon"></i>
      <input id="qInput" type="text" name="q" value="{{ q|default_if_none:'' }}"
             class="form-control" placeholder="Tìm theo mã đơn, tên, SĐT, địa chỉ…">
      <button type="button" class="btn-clear d-none" id="btnClear" aria-label="Xóa tìm">
        <i class="bi bi-x-circle"></i>
      </button>
    </div>

    <div class="me-2" style="min-width:220px">
      <select name="status" class="form-select" style="height:var(--h); border-radius:12px;">
        <option value="">-- Tất cả trạng thái --</option>
        <option value="cho_xu_ly" {% if status == 'cho_xu_ly' %}selected{% endif %}>Chờ xử lý</option>
        <option value="da_xac_nhan" {% if status == 'da_xac_nhan' %}selected{% endif %}>Đã xác nhận</option>
        <option value="dang_giao" {% if status == 'dang_giao' %}selected{% endif %}>Đang giao</option>
        <option value="hoan_thanh" {% if status == 'hoan_thanh' %}selected{% endif %}>Hoàn thành</option>
        <option value="da_huy" {% if status == 'da_huy' %}selected{% endif %}>Đã hủy</option>
      </select>
    </div>

    <button class="btn btn-find" type="submit">
      <i class="bi bi-funnel me-1"></i>Tìm
    </button>

    {% if q or status %}
    <a class="btn btn-light btn-reset" href="{% url 'shop:admin_orders' %}">
      <i class="bi bi-x-circle me-1"></i>Xóa lọc
    </a>
    {% endif %}
  </form>
</div>

<!-- Table -->
<div class="card shadow-sm table-flex">
  <div class="card-body card-body-tight">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th style="width:10%">Mã đơn</th>
            <th>Chủ tài khoản</th>
            <th class="text-end" style="width:14%">Tổng tiền</th>
            <th style="width:14%">Phương thức</th>
            <th style="width:14%">Trạng thái</th>
            <th style="width:16%">Ngày tạo</th>
            <th class="text-end" style="width:22%">Hành động</th>
          </tr>
        </thead>
        <tbody>
        {% if items %}
          {% for o in items %}
          <tr>
            <td><code class="small">{{ o.maNgan }}</code></td>
            <td>{{ o.taiKhoanTen }}</td>
            <td class="text-end">{{ o.tongTienFmt }} đ</td>
            <td>{{ o.pttt }}</td>
            <td><span class="badge bg-{{ o.badge }}">{{ o.trangThaiLabel }}</span></td>
            <td>{{ o.ngayTao|date:"d-m-Y H:i" }}</td>
            <td class="text-end">
              <div class="btn-group" role="group">
                <a class="btn btn-sm btn-outline-primary" href="{% url 'shop:admin_order_details' o.id %}" title="Chi tiết">
                  <i class="bi bi-eye"></i>
                </a>
                <a class="btn btn-sm btn-warning" href="{% url 'shop:admin_order_edit' o.id %}" title="Sửa">
                  <i class="bi bi-pencil"></i>
                </a>
                <a class="btn btn-sm btn-outline-danger" href="{% url 'shop:admin_order_delete' o.id %}" title="Xóa">
                  <i class="bi bi-trash"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="7" class="text-center text-muted py-4">Không có đơn hàng.</td></tr>
        {% endif %}
        </tbody>
      </table>
    </div>


      <!-- Sticky pagination -->
      <div class="pagination-fixed w-100">
        <div class="me-3 text-muted small">
          Trang {{ page }} / {{ total_pages }} • Tổng {{ total }} đơn
        </div>
        <nav aria-label="Pagination">
          <ul class="pagination mb-0">
            <li class="page-item {% if page|add:'-1' < 1 %}disabled{% endif %}">
              <a class="page-link" href="?page={{ page|add:'-1' }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status|urlencode }}{% endif %}">‹</a>
            </li>
            {% for p in page_numbers %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status|urlencode }}{% endif %}">{{ p }}</a>
              </li>
            {% endfor %}
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
              <a class="page-link" href="?page={{ page|add:'1' }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status|urlencode }}{% endif %}">›</a>
            </li>
          </ul>
        </nav>
      </div>

    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast-container" id="toastBox"></div>

<script>
(function(){
  const qInput = document.getElementById('qInput');
  const btnClear = document.getElementById('btnClear');
  const form = document.getElementById('searchForm');

  function toggleClear(){ btnClear.classList.toggle('d-none', !qInput.value.trim()); }
  btnClear?.addEventListener('click', ()=>{ qInput.value=''; toggleClear(); form.submit(); });
  qInput?.addEventListener('input', toggleClear);

  // keyboard shortcut "/"
  document.addEventListener('keydown', e=>{
    if(e.key==='/' && document.activeElement!==qInput){
      e.preventDefault(); qInput.focus(); qInput.select();
    }
  });
  toggleClear();

  // Toast helper
  function showToast(msg="Thao tác thành công", type="success"){
    const box=document.getElementById('toastBox');
    const el=document.createElement('div');
    el.className='toast';
    el.textContent=msg;
    if(type==="error"){ el.style.background="#dc2626"; }
    box.appendChild(el);
    setTimeout(()=> el.classList.add('show'), 30);
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(), 300); }, 3000);
  }
  window.showToast = showToast;

  // Render Django messages -> toast
  {% if messages %}
    {% for m in messages %}
      showToast("{{ m|escapejs }}", "{% if 'error' in m.tags %}error{% else %}success{% endif %}");
    {% endfor %}
  {% endif %}
})();
</script>
{% endblock %}
