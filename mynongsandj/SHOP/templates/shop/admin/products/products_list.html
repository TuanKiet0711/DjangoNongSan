{% extends "shop/admin/base_admin.html" %}
{% load humanize %}
{% block title %}S·∫£n ph·∫©m ¬∑ Admin{% endblock %}
{% block page_title %}S·∫£n ph·∫©m{% endblock %}

{% block content %}
<style>
  html, body {height: 100%; overflow: hidden;}
  .admin-fixed {height: 100vh; display:flex; flex-direction:column; overflow:hidden;}
  .toolbar-tight {margin-bottom:.5rem!important;}
  .card-body-tight {padding:.5rem 1rem!important;}
  .table-flex {flex:1 1 auto; min-height:0; overflow:hidden;}
  .alert, .messages, .django-messages {display:none !important;}

  .searchbar { --h: 38px; flex:1 1 auto; }
  .searchbar .inputbox {position:relative; flex:1 1 auto; min-width:300px;}
  .searchbar .inputbox .icon {position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.65; color:#6c757d;}
  .searchbar .inputbox input.form-control {height:var(--h); padding-left:38px; padding-right:40px; border-radius:12px; border:1px solid rgba(0,0,0,.08); box-shadow:0 6px 18px rgba(30,60,120,.06);}
  .searchbar .inputbox .btn-clear {position:absolute; right:10px; top:50%; transform:translateY(-50%); border:none; background:transparent; opacity:.5;}
  .searchbar .btn-find {height:var(--h); background:linear-gradient(180deg,#4f8cff 0%,#3b78ff 100%); color:#fff; border:none; font-weight:600; border-radius:12px; padding:.35rem .9rem; box-shadow:0 8px 16px rgba(60,120,240,.18);}
  .btn-reset {border-radius:12px; height:var(--h); margin-left:8px;}

  .thumb-img {width:80px; height:60px; object-fit:cover; border-radius:4px; border:1px solid #ddd;}

  .pagination-fixed {position:sticky; bottom:0; background:#fff; border-top:1px solid rgba(0,0,0,.05); padding:.5rem .75rem; display:flex; justify-content:flex-start; align-items:center;}
  .pagination-fixed .pagination {gap:4px; margin-bottom:0;}
  .pagination-fixed .page-link {min-width:34px; height:34px; padding:.25rem .6rem; text-align:center; border-radius:50%!important; color:#495057; border:none; background:#f8f9fa; box-shadow:0 2px 6px rgba(0,0,0,.05);}
  .pagination-fixed .page-link:hover {background:#4f8cff; color:#fff;}
  .pagination-fixed .page-item.active .page-link {background:#3b78ff; color:#fff; box-shadow:0 4px 12px rgba(60,120,240,.25);}
  .pagination-fixed .page-item.disabled .page-link {opacity:.5; pointer-events:none; background:#f1f1f1;}

  /* Toast g√≥c ph·∫£i */
  .toast-container{
    position:fixed;
    top:16px;
    right:16px;
    z-index:1080;
    display:flex;
    flex-direction:column;
    gap:8px;
    pointer-events:none;
  }
  .toast{
    min-width:220px;
    max-width:320px;
    background:#059669;
    color:#fff;
    padding:.6rem .9rem;
    border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.2);
    opacity:0;
    transform:translateY(-10px);
    transition:all .3s ease;
    pointer-events:auto;
  }
  .toast.show{opacity:1; transform:translateY(0);}
  .toast.error{background:#dc2626;}
</style>

<div class="admin-fixed">
  <!-- Toolbar -->
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 toolbar-tight">
    <form id="searchForm" class="d-flex searchbar" method="get" action="" style="min-width:420px">
      <div class="inputbox">
        <i class="bi bi-search icon"></i>
        <input id="qInput" type="text" name="q" value="{{ q|default_if_none:'' }}" class="form-control" placeholder="T√¨m theo t√™n s·∫£n ph·∫©m‚Ä¶">
        <button type="button" class="btn-clear d-none" id="btnClear" aria-label="X√≥a t√¨m">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
      <button class="btn btn-find" type="submit"><i class="bi bi-funnel me-1"></i>T√¨m</button>
      <a class="btn btn-light btn-reset" href="{% url 'shop:admin_products' %}"><i class="bi bi-x-circle me-1"></i>X√≥a l·ªçc</a>
    </form>
    <a class="btn btn-success btn-sm" href="{% url 'shop:admin_product_create' %}">+ Th√™m s·∫£n ph·∫©m</a>
  </div>

  <!-- B·∫£ng s·∫£n ph·∫©m -->
  <div class="card shadow-sm table-flex">
    <div class="card-body card-body-tight">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:12%">ID</th>
              <th style="width:18%">T√™n s·∫£n ph·∫©m</th>
              <th style="width:16%">Danh m·ª•c</th>
              <th style="width:18%">M√¥ t·∫£</th>
              <th style="width:8%">Gi√°</th>
              <th style="width:8%">T·ªìn kho</th>
              <th style="width:10%">·∫¢nh</th>
              <th class="text-end" style="width:10%">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
          {% if items %}
            {% for sp in items %}
              <tr>
                <td><code class="small">{{ sp.id }}</code></td>
                <td>{{ sp.ten }}</td>
                <td>{{ sp.danh_muc }}</td>
                <td class="small text-muted">{{ sp.mo_ta|truncatechars:50 }}</td>
                <td>{{ sp.gia|intcomma }} ƒë</td>
                <td>
                  {% if sp.so_luong_ton == 0 %}
                    <span class="badge text-bg-danger">H·∫øt (0)</span>
                  {% elif sp.so_luong_ton < 10 %}
                    <span class="badge text-bg-warning text-dark">Th·∫•p ({{ sp.so_luong_ton }})</span>
                  {% else %}
                    <span class="badge text-bg-success">C√≤n {{ sp.so_luong_ton }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if sp.hinh_anh %}
                    <img src="/media/{{ sp.hinh_anh }}" class="thumb-img" alt="·∫¢nh s·∫£n ph·∫©m {{ sp.ten }}">
                  {% else %}
                    <span class="text-muted small">Kh√¥ng c√≥ ·∫£nh</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'shop:admin_product_edit' sp.id %}">
                    <i class="bi bi-pencil"></i> S·ª≠a
                  </a>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'shop:admin_product_delete' sp.id %}">
                    <i class="bi bi-trash"></i> X√≥a
                  </a>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="8" class="text-center text-muted py-4">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination-fixed w-100">
        <div class="me-3 text-muted small">Trang {{ page }} / {{ total_pages }} ‚Ä¢ T·ªïng {{ total }} m·ª•c</div>
        <nav>
          <ul class="pagination mb-0">
            <li class="page-item {% if not has_prev %}disabled{% endif %}">
              <a class="page-link" href="?page={{ page|add:'-1' }}{% if q %}&q={{ q|urlencode }}{% endif %}">‚Äπ</a>
            </li>
            {% for p in page_numbers %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}{% if q %}&q={{ q|urlencode }}{% endif %}">{{ p }}</a>
              </li>
            {% endfor %}
            <li class="page-item {% if not has_next %}disabled{% endif %}">
              <a class="page-link" href="?page={{ page|add:'1' }}{% if q %}&q={{ q|urlencode }}{% endif %}">‚Ä∫</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast-container" id="toastBox" aria-live="polite" aria-atomic="true"></div>

<script>
(function(){
  console.log("‚úÖ Toast script loaded");

  const qInput = document.getElementById('qInput');
  const btnClear = document.getElementById('btnClear');
  const form = document.getElementById('searchForm');

  function toggleClear(){
    if(!btnClear || !qInput) return;
    btnClear.classList.toggle('d-none', !qInput.value.trim());
  }
  if(btnClear){
    btnClear.addEventListener('click', ()=>{
      qInput.value='';
      toggleClear();
      form.submit();
    });
  }
  if(qInput){
    qInput.addEventListener('input', toggleClear);
    document.addEventListener('keydown', e=>{
      if(e.key==='/' && document.activeElement!==qInput){
        e.preventDefault();
        qInput.focus();
        qInput.select();
      }
    });
  }
  toggleClear();

  // Toast function
  function showToast(msg="Thao t√°c th√†nh c√¥ng", type="success", opts={}){
    const box=document.getElementById('toastBox');
    if(!box){console.warn("‚ùå Kh√¥ng t√¨m th·∫•y toastBox"); return;}
    const el=document.createElement('div');
    el.className='toast'+(type==='error'?' error':'');
    el.textContent=msg;
    box.appendChild(el);
    requestAnimationFrame(()=>el.classList.add('show'));
    const timeout=Number.isFinite(opts.timeout)?opts.timeout:3000;
    setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),300);},timeout);
  }
  window.showToast=showToast;

  // Render Django messages ra toast
  {% if messages %}
    console.log("üì¢ Messages:", {{ messages|length }});
    {% for message in messages %}
      showToast("{{ message|escapejs }}", "{% if message.tags %}{{ message.tags }}{% else %}success{% endif %}");
    {% endfor %}
  {% else %}
    console.log("‚ÑπÔ∏è Kh√¥ng c√≥ messages ƒë·ªÉ hi·ªÉn th·ªã");
  {% endif %}
})();
</script>
{% endblock %}
