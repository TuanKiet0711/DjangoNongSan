{% extends "shop/admin/base_admin.html" %}
{% block title %}Xóa sản phẩm{% endblock %}
{% block page_title %}Xóa sản phẩm{% endblock %}

{% block content %}
<div class="card border-danger shadow-sm">
  <div class="card-body">
    <h5 class="text-danger">Bạn chắc chắn muốn xóa sản phẩm này?</h5>

    <p class="mb-1">ID: <code class="small">{{ product_id }}</code></p>

    <div class="mb-2">
      <strong>Tên:</strong> <span id="productName" class="fw-semibold">Đang tải…</span>
    </div>
    <div class="mb-2">
      <strong>Danh mục:</strong> <span id="productCategory">Đang tải…</span>
    </div>
    <div class="mb-2">
      <strong>Giá:</strong> <span id="productPrice">Đang tải…</span>
    </div>
    <div class="mb-2">
      <strong>Tồn kho:</strong> <span id="productStock">Đang tải…</span>
    </div>
    <div class="mb-2">
      <strong>Mô tả:</strong>
      <div id="productDesc" class="small text-muted"></div>
    </div>
    <div class="mb-3">
      <strong>Hình ảnh:</strong><br>
      <img id="productImage" src="" alt="Ảnh sản phẩm" style="max-height:120px; display:none; border:1px solid #ccc; padding:3px;">
    </div>

    <div class="d-flex gap-2">
      <button id="btnDelete" class="btn btn-danger">Xóa</button>
      <a class="btn btn-secondary" href="{% url 'shop:admin_products' %}">Hủy</a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(async function(){
  const id = "{{ product_id }}";

  function getCookie(name){
    let v=null;
    if(document.cookie){
      for(let c of document.cookie.split(';')){
        c=c.trim();
        if(c.startsWith(name+'=')){ v=decodeURIComponent(c.split('=')[1]); break; }
      }
    }
    return v;
  }
  const CSRF = getCookie('csrftoken');

  // Helper: format số có dấu phẩy
  const fmt = (n) => (Number(n||0)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

  // load product info (API trả camelCase)
  const res = await fetch(`/api/products/${id}/`);
  if(res.ok){
    const data = await res.json();

    // Tên / mô tả
    document.getElementById('productName').textContent = data.tenSanPham || '(không xác định)';
    document.getElementById('productDesc').textContent = data.moTa || '';

    // Danh mục: tạm hiển thị ID (nếu muốn tên, có thể truyền sẵn map tên danh mục từ view)
    document.getElementById('productCategory').textContent = data.danhMucId || 'Chưa phân loại';

    // Giá / tồn kho
    document.getElementById('productPrice').textContent = fmt(data.gia || 0) + ' đ';
    document.getElementById('productStock').textContent = String(data.soLuongTon || 0);

    // Ảnh: hỗ trợ cả URL tuyệt đối và đường dẫn tương đối trong /media
    const imgs = Array.isArray(data.hinhAnh) ? data.hinhAnh : [];
    if(imgs.length > 0){
      const first = imgs[0] || '';
      const src = /^https?:\/\//i.test(first) ? first : ('/media/' + first);
      const img = document.getElementById('productImage');
      img.src = src;
      img.style.display='block';
    }
  } else {
    document.getElementById('productName').textContent = 'Không tìm thấy';
  }

  // Xóa
  document.getElementById('btnDelete').addEventListener('click', async ()=>{
    if(!confirm('Xóa sản phẩm này?')) return;
    const r = await fetch(`/api/products/${id}/`, {
      method: 'DELETE',
      headers: { 'X-CSRFToken': CSRF }
    });
    if(r.ok){
      window.location = "{% url 'shop:admin_products' %}";
    } else {
      const err = await r.json().catch(()=>({}));
      alert(err.error || 'Không thể xóa');
    }
  });
})();
</script>
{% endblock %}
