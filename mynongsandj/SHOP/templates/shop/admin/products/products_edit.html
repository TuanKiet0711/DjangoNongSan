{% extends 'shop/admin/base_admin.html' %}
{% block title %}Sửa sản phẩm{% endblock %}
{% block page_title %}Sửa sản phẩm{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <form id="editForm" autocomplete="off" enctype="multipart/form-data">
      <div class="mb-3">
        <label class="form-label fw-semibold" for="ten">Tên sản phẩm</label>
        <input type="text" id="ten" class="form-control" required />
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold" for="mo_ta">Mô tả</label>
        <textarea id="mo_ta" class="form-control" rows="3"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold" for="gia">Giá (VNĐ)</label>
        <input
          type="text"
          id="gia"
          class="form-control"
          required
          inputmode="numeric"
          pattern="[0-9,]*"
          placeholder="Nhập giá"
          autocomplete="off"
        />
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">Hình ảnh</label>
        <input type="file" id="hinh_file" class="form-control mb-2" accept="image/*">
        <input type="text" id="hinh_url" class="form-control" placeholder="Hoặc dán URL ảnh">
        <div class="mt-2">
          <img id="preview_img" src="" alt="Xem trước" style="max-height:150px; display:none; border:1px solid #ccc; padding:3px;" />
        </div>
        <div class="form-text">Ưu tiên file nếu bạn chọn; nếu không, hệ thống dùng URL ở ô phía trên.</div>
      </div>

      <!-- Dropdown danh mục -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Danh mục</label>
        <input type="hidden" id="danh_muc_id" required>
        <div class="dropdown w-100">
          <button
            class="btn btn-outline-secondary w-100 d-flex justify-content-between align-items-center"
            type="button"
            id="btnDanhMuc"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <span id="labelDanhMuc">-- Chọn danh mục --</span>
            <span class="ms-2">▾</span>
          </button>
          <ul class="dropdown-menu w-100 p-1" style="max-height: 260px; overflow: auto;">
            {% for dm in categories %}
              <li>
                <a class="dropdown-item" href="#" data-id="{{ dm.id }}">{{ dm.ten }}</a>
              </li>
            {% endfor %}
          </ul>
        </div>
        <div class="form-text text-danger d-none" id="dmError">Vui lòng chọn danh mục</div>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-primary" type="submit">Lưu thay đổi</button>
        <a class="btn btn-secondary" href="{% url 'shop:admin_products' %}">Hủy</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
;(async function () {
  const id = '{{ product_id }}';

  function getCookie(name) {
    let v = null;
    if (document.cookie)
      for (let c of document.cookie.split(';')) {
        c = c.trim();
        if (c.startsWith(name + '=')) {
          v = decodeURIComponent(c.split('=')[1]);
          break;
        }
      }
    return v;
  }
  const CSRF = getCookie('csrftoken');

  const $ten = document.getElementById('ten');
  const $mo_ta = document.getElementById('mo_ta');
  const $gia = document.getElementById('gia');
  const $file = document.getElementById('hinh_file');
  const $url = document.getElementById('hinh_url');
  const $preview = document.getElementById('preview_img');

  // Dropdown danh mục
  const dmHidden = document.getElementById('danh_muc_id');
  const dmLabel  = document.getElementById('labelDanhMuc');
  const dmError  = document.getElementById('dmError');
  const dmMenu   = document.querySelector('.dropdown .dropdown-menu');
  dmMenu.addEventListener('click', (e) => {
    const item = e.target.closest('.dropdown-item');
    if (!item) return;
    e.preventDefault();
    dmHidden.value = item.dataset.id || '';
    dmLabel.textContent = item.textContent.trim() || '-- Chọn danh mục --';
    dmError.classList.add('d-none');
  });

  // Format giá: dấu phẩy phân cách nghìn
  const formatComma = (digitsStr) => {
    const clean = (digitsStr || '').replace(/[^\d]/g, '');
    if (!clean) return '';
    return clean.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  };
  $gia.addEventListener('input', (e) => {
    const val = e.target.value;
    const formatted = formatComma(val);
    if (formatted !== val) {
      const end = formatted.length;
      e.target.value = formatted;
      e.target.setSelectionRange(end, end);
    }
  });
  $gia.addEventListener('blur', (e) => {
    e.target.value = formatComma(e.target.value);
  });

  // Load dữ liệu hiện tại
  const res = await fetch(`/api/products/${id}/`);
  if (!res.ok) {
    alert('Không tìm thấy sản phẩm');
    window.location = "{% url 'shop:admin_products' %}";
    return;
  }
  const cur = await res.json();

  $ten.value = cur.ten_san_pham || '';
  $mo_ta.value = cur.mo_ta || '';
  $gia.value = formatComma(String(cur.gia || 0));
  dmHidden.value = cur.danh_muc_id || '';
  if (cur.danh_muc_id) {
    const activeItem = dmMenu.querySelector(`[data-id="${cur.danh_muc_id}"]`);
    if (activeItem) dmLabel.textContent = activeItem.textContent.trim();
  }

  if (cur.hinh_anh && cur.hinh_anh.length > 0) {
    $preview.src = '/media/' + cur.hinh_anh[0];
    $preview.style.display = 'block';
    $url.value = cur.hinh_anh[0];
  }

  // Preview khi chọn file
  $file.addEventListener('change', () => {
    if ($file.files && $file.files[0]) {
      const blob = URL.createObjectURL($file.files[0]);
      $preview.src = blob;
      $preview.style.display = 'block';
    }
  });
  // Preview khi nhập URL
  $url.addEventListener('input', () => {
    const val = $url.value.trim();
    if (val && !$file.files.length) {
      $preview.src = val.startsWith('http') ? val : ('/media/' + val);
      $preview.style.display = 'block';
    } else if (!val && !$file.files.length) {
      $preview.style.display = 'none';
    }
  });

  // Submit PUT (multipart/form-data)
  document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!$ten.value.trim() || !dmHidden.value) {
      if (!dmHidden.value) dmError.classList.remove('d-none');
      alert('Vui lòng nhập đủ thông tin');
      return;
    }

    const fd = new FormData();
    fd.append('ten_san_pham', $ten.value.trim());
    fd.append('mo_ta', $mo_ta.value.trim());
    fd.append('gia', String(parseInt($gia.value.replace(/[^\d]/g, ''), 10) || 0));
    fd.append('danh_muc_id', dmHidden.value);

    if ($file.files.length > 0) {
      fd.append('hinh_anh', $file.files[0]);
    } else if ($url.value.trim()) {
      fd.append('hinh_anh', $url.value.trim());
    }

    const r = await fetch(`/api/products/${id}/`, {
      method: 'PUT',
      headers: { 'X-CSRFToken': CSRF },
      body: fd,
      credentials: 'same-origin',
    });

    if (r.ok) {
      window.location = "{% url 'shop:admin_products' %}";
    } else {
      const err = await r.json().catch(() => ({}));
      alert(err.error || 'Lưu thất bại');
    }
  });
})();
</script>
{% endblock %}
