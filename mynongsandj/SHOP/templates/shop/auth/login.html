{% extends "customer/base.html" %}
{% load static %}

{% block title %}Đăng nhập · Nông Sản Sạch{% endblock %}

{% block content %}
<style>
  .login-container {
    max-width: 460px;
    margin: 60px auto;
    padding: 2rem 2.2rem;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }

  .login-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .login-header .logo {
    width: 70px;
    height: 70px;
    object-fit: cover;
    border-radius: 50%;
    background: #e9f7ef;
    padding: 8px;
  }

  .login-header h4 {
    font-weight: 700;
    color: #28a745;
    margin-top: 0.8rem;
  }

  .form-label {
    font-weight: 600;
    color: #155724;
  }

  .form-control {
    border-radius: 12px;
    border: 1px solid #e5e7eb;
  }

  .form-control:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 .25rem rgba(40,167,69,.15);
  }

  .btn-brand {
    background: linear-gradient(135deg, #28a745, #1e9b3a);
    border: none;
    color: #fff;
    font-weight: 700;
    border-radius: 12px;
    padding: .65rem 1rem;
    box-shadow: 0 6px 16px rgba(30,155,58,.25);
    transition: transform .06s ease, box-shadow .2s ease;
  }

  .btn-brand:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(30,155,58,.32);
  }

  .toggle-pass {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: #6c757d;
  }

  .input-icon-right {
    position: relative;
  }

  #msg {
    border-radius: 10px;
  }

  .text-muted a {
    color: #198754;
    text-decoration: none;
  }

  .text-muted a:hover {
    text-decoration: underline;
  }
</style>

<div class="login-container">
  <div class="login-header">
   
    <h4><i class="bi bi-box-arrow-in-right me-1"></i> Đăng nhập</h4>
   
  </div>

  <div id="msg" class="alert alert-danger d-none"></div>

  <form id="formLogin" class="vstack gap-3" autocomplete="off" novalidate>
    <div>
      <label class="form-label" for="email">Email</label>
      <input id="email" type="email" class="form-control" placeholder="Nhập email" required autocomplete="username">
    </div>
    <div>
      <label class="form-label" for="password">Mật khẩu</label>
      <div class="input-icon-right">
        <input id="password" type="password" class="form-control" placeholder="Nhập mật khẩu" required autocomplete="current-password">
        <button type="button" class="toggle-pass"><i class="bi bi-eye"></i></button>
      </div>
    </div>

    <button class="btn btn-brand w-100 mt-1" type="submit">
      <span class="btn-text"><i class="bi bi-box-arrow-in-right me-1"></i> Đăng nhập</span>
      <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý…</span>
    </button>
  </form>

  <div class="text-center mt-3 text-muted">
    <span>Chưa có tài khoản?</span>
    <a href="{% url 'shop:auth_register_page' %}">Đăng ký ngay</a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const $ = (s)=>document.querySelector(s);
  const msg = $("#msg");
  const form = $("#formLogin");
  const btn = form.querySelector('button[type="submit"]');
  const btnText = btn.querySelector(".btn-text");
  const btnLoading = btn.querySelector(".btn-loading");
  const togglePassBtn = document.querySelector(".toggle-pass");
  const passInput = $("#password");

  // Hiện/ẩn mật khẩu
  togglePassBtn?.addEventListener("click", ()=>{
    const isPwd = passInput.type === "password";
    passInput.type = isPwd ? "text" : "password";
    togglePassBtn.innerHTML = isPwd ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
    passInput.focus();
  });

  // Xử lý đăng nhập
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    msg.classList.add("d-none");
    const email = $("#email").value.trim().toLowerCase();
    const matKhau = $("#password").value.trim();
    if (!email || !matKhau) return;

    btn.disabled = true;
    btnText.classList.add("d-none");
    btnLoading.classList.remove("d-none");

    try{
      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({email, matKhau})
      });
      const data = await res.json().catch(()=> ({}));

      if(!res.ok){
        msg.textContent = data?.error || "Đăng nhập thất bại, vui lòng thử lại.";
        msg.classList.remove("d-none");
        return;
      }

      const role = (data?.user?.vaiTro || "").toLowerCase();
      if (role === "admin") window.location.href = "/admin-panel/";
      else window.location.href = "/";
    }catch{
      msg.textContent = "Không thể kết nối máy chủ.";
      msg.classList.remove("d-none");
    }finally{
      btn.disabled = false;
      btnText.classList.remove("d-none");
      btnLoading.classList.add("d-none");
    }
  });
</script>
{% endblock %}
