{% extends "customer/base.html" %}
{% load static %}
{% block title %}Chi ti·∫øt ƒë∆°n h√†ng{% endblock %}
{% block content %}

<div class="container py-4">
  <a href="/don-hang/" class="btn btn-sm btn-outline-secondary mb-3">
    <i class="bi bi-arrow-left"></i> Quay l·∫°i danh s√°ch
  </a>

  <div id="order-detail"></div>
</div>

<style>
  .order-card{border:1px solid #e9ecef;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.05)}
  .section-title{font-weight:800;font-size:1.05rem;margin-bottom:.75rem;color:#14532d}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:.35rem .75rem}
  .kv .k{color:#6b7280}
  .kv .v{font-weight:600}
  .divider{height:1px;background:#eef2f3;margin:1rem 0}
  .status-badge{border-radius:999px;padding:.35rem .6rem;font-weight:700;border:1px solid transparent}
  .st-cho_xu_ly   { background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
  .st-da_xac_nhan { background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe; }
  .st-dang_giao   { background:#f0f9ff; color:#0369a1; border-color:#bae6fd; }
  .st-hoan_thanh  { background:#ecfdf5; color:#065f46; border-color:#bbf7d0; }
  .st-da_huy      { background:#fef2f2; color:#991b1b; border-color:#fecaca; }
  .product-img{width:52px;height:52px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb}
  .table thead th{background:#f8fafc}
  .table td, .table th{vertical-align:middle}
  .form-like{background:#f9fffb;border:1px dashed #b7e4c7;border-radius:12px;padding:12px}
</style>

<script>
  function formatDateVN(dateStr){
    if(!dateStr) return '';
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr;
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }
  function formatPaymentVN(method){
    if(!method) return '';
    const m = (method+'').toLowerCase();
    if (m.includes('cod')) return 'Thanh to√°n khi nh·∫≠n h√†ng';
    if (m.includes('chuyen') || m.includes('bank')) return 'Chuy·ªÉn kho·∫£n';
    if (m.includes('vnpay')) return 'VNPAY';
    return method;
  }
  function formatStatusVN(status){
    const s = (status || '').toLowerCase();
    const map = {'cho_xu_ly':'Ch·ªù x·ª≠ l√Ω','da_xac_nhan':'ƒê√£ x√°c nh·∫≠n','dang_giao':'ƒêang giao','hoan_thanh':'Ho√†n th√†nh','da_huy':'ƒê√£ h·ªßy'};
    return map[s] || status;
  }
  async function getProduct(id){
    try{ const r = await fetch(`/api/products/${id}/`, {credentials:'same-origin'});
      if(!r.ok) return null; return await r.json();
    }catch{ return null; }
  }
  async function loadOrder(){
    // n·∫øu c√≥ ?paid=1 => show toast
    const qp = new URLSearchParams(location.search);
    if(qp.get('paid')==='1'){ setTimeout(()=>alert('üéâ Thanh to√°n th√†nh c√¥ng! ƒê∆°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.'), 100); }

    const res = await fetch(`/api/orders/{{ order_id }}/`, {credentials:'same-origin'});
    if(res.status===401) return location.href = "{% url 'shop:auth_login_page' %}";
    const o = await res.json();
    const wrap = document.getElementById('order-detail');
    if(o.error){ wrap.innerHTML = `<div class="alert alert-danger">${o.error}</div>`; return; }

    let rows = '';
    for(const it of (o.items || [])){
      const p = await getProduct(it.sanPhamId);
      const rawImg = p && (p.hinhAnh?.[0] || p.anh);
      const img = rawImg ? `/media/${rawImg}` : '/static/img/no-image.png';
      const name = p && p.tenSanPham ? p.tenSanPham : '(Kh√¥ng r√µ t√™n)';
      rows += `
        <tr>
          <td>
            <div class="d-flex align-items-center gap-2">
              <img src="${img}" alt="${name}" class="product-img">
              <div class="fw-semibold">${name}</div>
            </div>
          </td>
          <td class="text-center">${(it.soLuong||0)}</td>
          <td class="text-end">${Number(it.donGia||0).toLocaleString('vi-VN')} ƒë</td>
          <td class="text-end">${Number(it.thanhTien||0).toLocaleString('vi-VN')} ƒë</td>
        </tr>`;
    }

    const statusClass = `st-${o.trangThai}`;
    const statusVN = formatStatusVN(o.trangThai);
    const payVN = formatPaymentVN(o.phuongThucThanhToan);

    wrap.innerHTML = `
      <div class="order-card p-4">
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
          <div class="d-flex align-items-center gap-2">
            <h4 class="m-0 text-success fw-bold">Chi ti·∫øt ƒë∆°n h√†ng</h4>
            <span class="status-badge ${statusClass}" title="${o.trangThai}">${statusVN}</span>
          </div>
          <div class="text-muted">T·ªïng ti·ªÅn: <span class="fw-bold">${Number(o.tongTien||0).toLocaleString('vi-VN')} ƒë</span></div>
        </div>
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="form-like">
              <div class="section-title"><i class="bi bi-receipt-cutoff me-1"></i> Th√¥ng tin ƒë∆°n</div>
              <div class="kv">
                <div class="k">M√£ ƒë∆°n</div><div class="v">#${o.id}</div>
                <div class="k">Tr·∫°ng th√°i</div><div class="v">${statusVN}</div>
                <div class="k">Ph∆∞∆°ng th·ª©c thanh to√°n</div><div class="v">${payVN}</div>
                <div class="k">T·ªïng ti·ªÅn</div><div class="v text-success">${Number(o.tongTien||0).toLocaleString('vi-VN')} ƒë</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="form-like">
              <div class="section-title"><i class="bi bi-geo-alt me-1"></i> Th√¥ng tin giao h√†ng</div>
              <div class="kv">
                <div class="k">H·ªç t√™n</div><div class="v">${o.shipping?.hoTen || ''}</div>
                <div class="k">ƒêi·ªán tho·∫°i</div><div class="v">${o.shipping?.soDienThoai || ''}</div>
                <div class="k">ƒê·ªãa ch·ªâ</div><div class="v">${o.shipping?.diaChi || ''}</div>
                <div class="k">Ng√†y giao (mong mu·ªën)</div><div class="v">${formatDateVN(o.shipping?.ngayGiao)}</div>
                <div class="k">Ghi ch√∫</div><div class="v">${o.shipping?.ghiChu || ''}</div>
              </div>
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="section-title"><i class="bi bi-bag-check me-1"></i> S·∫£n ph·∫©m</div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead><tr>
              <th style="min-width:240px">T√™n s·∫£n ph·∫©m</th>
              <th class="text-center" style="width:100px">SL</th>
              <th class="text-end" style="width:160px">ƒê∆°n gi√°</th>
              <th class="text-end" style="width:180px">Th√†nh ti·ªÅn</th>
            </tr></thead>
            <tbody>${rows || `<tr><td colspan="4" class="text-center text-muted py-4">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>`}</tbody>
          </table>
        </div>
      </div>`;
  }
  loadOrder();
</script>
{% if paid_success %}
<script>
  alert("üéâ Thanh to√°n th√†nh c√¥ng! ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.");
</script>
{% endif %}

{% endblock %}
