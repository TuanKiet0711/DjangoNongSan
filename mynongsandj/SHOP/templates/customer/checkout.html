{% extends 'customer/base.html' %}
{% block content %}
<h2 class="mb-3">Thanh toán</h2>
<form id="checkoutForm" class="card p-3 shadow-sm rounded-3" onsubmit="return submitOrder(event)">
  <div class="mb-3">
    <label>Họ tên</label>
    <input class="form-control" name="hoTen" required>
  </div>
  <div class="mb-3">
    <label>Số điện thoại</label>
    <input class="form-control" name="soDienThoai" required>
  </div>
  <div class="mb-3">
    <label>Địa chỉ</label>
    <textarea class="form-control" name="diaChi" required></textarea>
  </div>
  <div class="mb-3">
    <label>Ngày giao</label>
    <input type="date" class="form-control" name="ngayGiao">
  </div>
  <div class="mb-3">
    <label>Ghi chú</label>
    <input class="form-control" name="ghiChu">
  </div>
  <div class="mb-3">
    <label>Phương thức thanh toán</label>
    <select class="form-select" name="paymentMethod">
      <option value="cod">Thanh toán khi nhận hàng</option>
      <option value="chuyen_khoan">Chuyển khoản</option>
    </select>
  </div>
  <button class="btn btn-success">Đặt hàng</button>
</form>

<script>
async function submitOrder(e) {
  e.preventDefault();
  const f = e.target;
  const data = {
    shipping: {
      hoTen: f.hoTen.value,
      soDienThoai: f.soDienThoai.value,
      diaChi: f.diaChi.value,
      ngayGiao: f.ngayGiao.value,
      ghiChu: f.ghiChu.value,
    },
    paymentMethod: f.paymentMethod.value
  };
  const res = await fetch('/api/orders/checkout', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  if (res.status === 401) return location.href = "{% url 'shop:auth_login_page' %}";
  const js = await res.json();
  if (js.created) {
    alert('Đặt hàng thành công!');
    location.href = '/don-hang/' + js.created + '/';
  } else {
    alert('Lỗi: ' + (js.error || res.status));
  }
}
</script>
{% endblock %}
