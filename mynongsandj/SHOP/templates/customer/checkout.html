{% extends "customer/base.html" %}
{% load static %}
{% block title %}ƒê·∫∑t h√†ng{% endblock %}
{% block content %}

<style>
  .checkout-cart-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .75rem;
    padding: .5rem 0;
    border-bottom: 1px solid #e9ecef;
  }

  .checkout-cart-item:last-child {
    border-bottom: none;
  }

  .checkout-cart-item .left {
    display: flex;
    align-items: center;
    gap: .6rem;
    min-width: 0;
  }

  /* ‚úÖ Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc ·∫£nh */
  .checkout-cart-item .thumb {
    width: 60px;
    height: 60px;
    flex: 0 0 60px;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid #dee2e6;
    background: #fff;
  }

  .checkout-cart-item .name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 280px;
    font-weight: 500;
  }

  .card-title {
    font-weight: 600;
  }
</style>

<section class="py-4">
  <div class="container">
    <h2 class="h4 mb-4">
      <i class="bi bi-bag-check me-2"></i>ƒê·∫∑t h√†ng
    </h2>

    <div class="row g-4">
      <!-- LEFT: th√¥ng tin nh·∫≠n h√†ng -->
      <div class="col-lg-8">
        <div class="card border-success-subtle mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Th√¥ng tin nh·∫≠n h√†ng</h5>
            <form id="checkoutForm" class="row g-3">
              <div class="col-md-6">
                <label class="form-label">H·ªç v√† t√™n</label>
                <input name="hoTen" type="text" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                <input name="soDienThoai" type="tel" class="form-control" required>
              </div>
              <div class="col-12">
                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                <input name="diaChi" type="text" class="form-control" required>
              </div>
              <div class="col-12">
                <label class="form-label">Ghi ch√∫</label>
                <textarea name="ghiChu" class="form-control" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ng√†y giao</label>
                <input name="ngayGiao" type="date" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                <select name="paymentMethod" class="form-select">
                  <option value="cod">COD (Thanh to√°n khi nh·∫≠n h√†ng)</option>
                  <option value="chuyen_khoan">Chuy·ªÉn kho·∫£n</option>
                </select>
              </div>
            </form>
          </div>
        </div>

        <!-- ‚úÖ S·∫£n ph·∫©m trong ƒë∆°n -->
        <div class="card border-success-subtle">
          <div class="card-body">
            <h5 class="card-title mb-3">S·∫£n ph·∫©m trong ƒë∆°n</h5>
            <div id="cartList" class="small mb-2 text-muted"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: T·ªïng c·ªông -->
      <div class="col-lg-4">
        <div class="card border-success-subtle">
          <div class="card-body">
            <h5 class="card-title">T·ªïng c·ªông</h5>
            <div class="fs-5 fw-semibold text-end mb-3" id="sumTotal">0 ƒë</div>
            <button id="btnPlaceOrder" class="btn btn-success w-100">
              <i class="bi bi-check2-circle me-1"></i> X√°c nh·∫≠n ƒë·∫∑t h√†ng
            </button>
            <a href="/" class="btn btn-outline-success w-100 mt-2">‚Üê Ti·∫øp t·ª•c mua s·∫Øm</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(async () => {
  const cartList = document.getElementById('cartList');
  const sumTotal = document.getElementById('sumTotal');
  const urlParams = new URLSearchParams(window.location.search);
  const buyNowId = urlParams.get('buy_now');

  // üü¢ Load gi·ªè h√†ng ho·∫∑c s·∫£n ph·∫©m mua ngay
  async function loadCart() {
    try {
      let items = [];
      let total = 0;

      if (buyNowId) {
        // MUA NGAY
        const res = await fetch(`/api/products/${buyNowId}/`);
        const sp = await res.json();
        if (!res.ok || !sp.tenSanPham) throw new Error('product_not_found');

        const img = sp.hinhAnh && sp.hinhAnh[0]
          ? `/media/${sp.hinhAnh[0]}`
          : '/static/img/no-image.png';

        items.push({
          tenSanPham: sp.tenSanPham,
          soLuong: 1,
          thanhTien: sp.gia,
          hinhAnh: img
        });
        total = sp.gia;
      } else {
        // T·ª™ GI·ªé H√ÄNG
        const res = await fetch('/api/cart/list/', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('cart_error');
        const data = await res.json();
        items = data.items || [];
        total = data.total || 0;
      }

      // Render
      if (!items.length) {
        cartList.innerHTML = '<div class="text-danger">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o!</div>';
        sumTotal.textContent = '0 ƒë';
        return;
      }

      let html = '';
      for (const it of items) {
        const ten = it.tenSanPham || '(Kh√¥ng r√µ s·∫£n ph·∫©m)';
        const img = it.hinhAnh || '/static/img/no-image.png';
        const sl = it.soLuong || 1;
        const tt = it.thanhTien || 0;

        html += `
          <div class="checkout-cart-item">
            <div class="left">
              <img src="${img}" class="thumb" alt="${ten}">
              <div class="name">${ten} √ó ${sl}</div>
            </div>
            <div class="fw-semibold">${tt.toLocaleString('vi-VN')} ƒë</div>
          </div>`;
      }

      cartList.innerHTML = html;
      sumTotal.textContent = total.toLocaleString('vi-VN') + ' ƒë';
    } catch (err) {
      console.error('loadCart error:', err);
      cartList.innerHTML = '<div class="text-danger">Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!</div>';
    }
  }

  // üü¢ H√†m th√¥ng b√°o ƒë∆°n gi·∫£n
  function showToast(message, success = true) {
    alert(message);
  }

  // üü© G·ª≠i y√™u c·∫ßu ƒë·∫∑t h√†ng
  document.getElementById('btnPlaceOrder').addEventListener('click', async () => {
    const f = document.getElementById('checkoutForm');
    const data = {
      shipping: {
        hoTen: f.hoTen.value,
        soDienThoai: f.soDienThoai.value,
        diaChi: f.diaChi.value,
        ngayGiao: f.ngayGiao.value,
        ghiChu: f.ghiChu.value,
      },
      paymentMethod: f.paymentMethod.value
    };

    // N·∫øu l√† MUA NGAY th√¨ g·ª≠i th√™m th√¥ng tin s·∫£n ph·∫©m
    if (buyNowId) {
      data.buyNowProductId = buyNowId;
      data.buyNowQuantity = 1;
    }

    try {
      const res = await fetch('/api/orders/checkout', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify(data)
      });

      const js = await res.json();
      if (res.ok && js.created) {
        showToast('üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!');
        setTimeout(() => location.href = '/don-hang/' + js.created + '/', 1500);
      } else {
        showToast('‚ùå L·ªói: ' + (js.error || res.status), false);
      }
    } catch (err) {
      console.error('checkout error', err);
      showToast('‚ùå Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu ƒë·∫∑t h√†ng!', false);
    }
  });

  loadCart();
})();
</script>

{% endblock %}
