{% extends "customer/base.html" %}
{% load static %}
{% block title %}ƒê·∫∑t h√†ng{% endblock %}
{% block content %}

<style>
  .checkout-cart-item{
    display:flex;align-items:center;justify-content:space-between;
    gap:.75rem;padding:.5rem 0;border-bottom:1px solid #e9ecef;
  }
  .checkout-cart-item:last-child{border-bottom:none}
  .checkout-cart-item .left{display:flex;align-items:center;gap:.6rem;min-width:0}
  .checkout-cart-item .thumb{
    width:60px;height:60px;flex:0 0 60px;border-radius:8px;object-fit:cover;
    border:1px solid #dee2e6;background:#fff
  }
  .checkout-cart-item .name{
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px;font-weight:500
  }
  .card-title{font-weight:600}
  .bank-hint{background:#f6fff8;border:1px solid #cfead6;border-radius:.5rem}
  .bank-hint .form-label{margin-bottom:.25rem}
  .bank-hint .input-group>.form-control{background:#fff}
  .copy-btn{white-space:nowrap}
</style>

<section class="py-4">
  <div class="container">
    <h2 class="h4 mb-4"><i class="bi bi-bag-check me-2"></i>ƒê·∫∑t h√†ng</h2>

    <div class="row g-4">
      <!-- LEFT: th√¥ng tin nh·∫≠n h√†ng -->
      <div class="col-lg-8">
        <div class="card border-success-subtle">
          <div class="card-body">
            <h5 class="card-title mb-3">Th√¥ng tin nh·∫≠n h√†ng</h5>

            <form id="checkoutForm" class="row g-3" novalidate>
              <div class="col-md-6">
                <label class="form-label">H·ªç v√† t√™n</label>
                <input name="hoTen" type="text" class="form-control" required placeholder="Nh·∫≠p h·ªç v√† t√™n">
              </div>
              <div class="col-md-6">
                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                <input
                  name="soDienThoai"
                  id="inputPhone"
                  type="tel"
                  class="form-control"
                  required
                  inputmode="numeric"
                  pattern="^[0-9]{9,12}$"
                  maxlength="12"
                  placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
              </div>

              <div class="col-12">
                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                <input name="diaChi" type="text" class="form-control" required
                       placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
              </div>

              <div class="col-12">
                <label class="form-label">Ghi ch√∫</label>
                <textarea name="ghiChu" class="form-control" rows="2"
                          placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)"></textarea>
              </div>

              <div class="col-md-6">
                <label class="form-label">Ng√†y giao <span class="text-muted">(mong mu·ªën)</span></label>
                <input name="ngayGiao" id="ngayGiao" type="date" class="form-control" aria-describedby="ngayHelp">
                
              </div>

              <div class="col-md-6">
                <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                <select name="paymentMethod" id="paymentMethod" class="form-select">
                  <option value="cod" selected>COD (Thanh to√°n khi nh·∫≠n h√†ng)</option>
                  <option value="chuyen_khoan">Chuy·ªÉn kho·∫£n</option>
                </select>
              </div>

              <!-- H∆Ø·ªöNG D·∫™N CHUY·ªÇN KHO·∫¢N -->
              <div class="col-12 d-none" id="bankGuide">
                <div class="p-3 bank-hint">
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-bank me-2"></i>
                    <strong>H∆∞·ªõng d·∫´n chuy·ªÉn kho·∫£n</strong>
                  </div>

                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Ng√¢n h√†ng</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="bankName" value="Vietcombank (VCB)" readonly>
                        <button class="btn btn-outline-success copy-btn" type="button" data-copy="#bankName"><i class="bi bi-clipboard"></i> Copy</button>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">S·ªë t√†i kho·∫£n</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="bankNo" value="111111111" readonly>
                        <button class="btn btn-outline-success copy-btn" type="button" data-copy="#bankNo"><i class="bi bi-clipboard"></i> Copy</button>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Ch·ªß t√†i kho·∫£n</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="bankOwner" value="L√™ Tu·∫•n Tinh" readonly>
                        <button class="btn btn-outline-success copy-btn" type="button" data-copy="#bankOwner"><i class="bi bi-clipboard"></i> Copy</button>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">N·ªôi dung chuy·ªÉn kho·∫£n</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="bankMemo" value="Thanh toan don hang - SDT: " readonly>
                        <button class="btn btn-outline-success copy-btn" type="button" data-copy="#bankMemo"><i class="bi bi-clipboard"></i> Copy</button>
                      </div>
                     
                    </div>
                  </div>
                </div>
              </div>
              <!-- /H∆Ø·ªöNG D·∫™N CHUY·ªÇN KHO·∫¢N -->
            </form>
          </div>
        </div>
      </div>

      <!-- RIGHT: T·ªïng ti·ªÅn + danh s√°ch s·∫£n ph·∫©m -->
      <div class="col-lg-4">
        <div class="card border-success-subtle">
          <div class="card-body">
            <h5 class="card-title">T·ªïng ti·ªÅn</h5>

            <div id="cartList" class="small mb-3 text-muted"></div>

            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="fw-semibold">T·ªïng ti·ªÅn</span>
              <span id="sumTotal" class="fs-5 fw-semibold">0 ƒë</span>
            </div>

            <button id="btnPlaceOrder" class="btn btn-success w-100">
              <i class="bi bi-check2-circle me-1"></i> X√°c nh·∫≠n ƒë·∫∑t h√†ng
            </button>
            <a href="/" class="btn btn-outline-success w-100 mt-2">‚Üê Ti·∫øp t·ª•c mua s·∫Øm</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(async () => {
  const cartList   = document.getElementById('cartList');
  const sumTotal   = document.getElementById('sumTotal');
  const paymentSel = document.getElementById('paymentMethod');
  const bankGuide  = document.getElementById('bankGuide');
  const bankMemo   = document.getElementById('bankMemo');
  const inputPhone = document.getElementById('inputPhone');
  const inputDate  = document.getElementById('ngayGiao');

  const urlParams = new URLSearchParams(window.location.search);
  const buyNowId = urlParams.get('buy_now');

  // ====== Gi·ªõi h·∫°n ng√†y giao: kh√¥ng qu√° kh·ª© ======
  function todayISO(){
    const d = new Date();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${m}-${day}`;
  }
  const minDate = todayISO();
  inputDate.setAttribute('min', minDate);

  // ====== SƒêT: ch·ªâ s·ªë 9‚Äì12 ======
  const digitsOnly = (s) => (s || '').replace(/\D+/g, '').slice(0, 12);
  function sanitizePhone() {
    const cur = inputPhone.value;
    const clean = digitsOnly(cur);
    if (cur !== clean) inputPhone.value = clean;
  }
  inputPhone.addEventListener('input', sanitizePhone);
  inputPhone.addEventListener('paste', (e) => {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text');
    document.execCommand('insertText', false, digitsOnly(text));
  });
  inputPhone.addEventListener('drop', (e) => {
    e.preventDefault();
    const text = e.dataTransfer.getData('text');
    inputPhone.value = digitsOnly(text);
  });
  inputPhone.addEventListener('keypress', (e) => {
    const isDigit = /[0-9]/.test(e.key);
    const isCtrl = ["Backspace","Delete","ArrowLeft","ArrowRight","Tab","Enter"].includes(e.key);
    if (!isDigit && !isCtrl) e.preventDefault();
  });

  // Toggle h∆∞·ªõng d·∫´n chuy·ªÉn kho·∫£n
  function toggleBankGuide(){
    bankGuide.classList.toggle('d-none', paymentSel.value !== 'chuyen_khoan');
  }
  paymentSel.addEventListener('change', toggleBankGuide);
  toggleBankGuide();

  // Copy helper
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-copy]');
    if(!btn) return;
    const sel = btn.getAttribute('data-copy');
    const input = document.querySelector(sel);
    if(!input) return;
    try{
      await navigator.clipboard.writeText(input.value || '');
      alert('‚úÖ ƒê√£ sao ch√©p!');
    }catch(_){
      alert('‚ùå Kh√¥ng sao ch√©p ƒë∆∞·ª£c. Vui l√≤ng copy th·ªß c√¥ng.');
    }
  });

  // G·ª£i √Ω SƒêT v√†o n·ªôi dung CK
  inputPhone.addEventListener('input', () => {
    const phone = (inputPhone.value || '').replace(/\s+/g,'');
    bankMemo.value = 'Thanh toan don hang - SDT: ' + phone;
  });

  // Load gi·ªè h√†ng ho·∫∑c s·∫£n ph·∫©m mua ngay
  async function loadCart() {
    try {
      let items = [];
      let total = 0;

      if (buyNowId) {
        const res = await fetch(`/api/products/${buyNowId}/`);
        const sp = await res.json();
        if (!res.ok || !sp.tenSanPham) throw new Error('product_not_found');

        const img = sp.hinhAnh && sp.hinhAnh[0]
          ? `/media/${sp.hinhAnh[0]}`
          : '/static/img/no-image.png';

        items.push({ tenSanPham: sp.tenSanPham, soLuong: 1, thanhTien: sp.gia, hinhAnh: img });
        total = sp.gia;
      } else {
        const res = await fetch('/api/cart/list/', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('cart_error');
        const data = await res.json();
        items = data.items || [];
        total = data.total || 0;
      }

      if (!items.length) {
        cartList.innerHTML = '<div class="text-danger">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o!</div>';
        sumTotal.textContent = '0 ƒë';
        return;
      }

      let html = '';
      for (const it of items) {
        const ten = it.tenSanPham || '(Kh√¥ng r√µ s·∫£n ph·∫©m)';
        const img = it.hinhAnh || '/static/img/no-image.png';
        const sl  = it.soLuong || 1;
        const tt  = Number(it.thanhTien || 0);

        html += `
          <div class="checkout-cart-item">
            <div class="left">
              <img src="${img}" class="thumb" alt="${ten}">
              <div class="name" title="${ten}">${ten} √ó ${sl}</div>
            </div>
            <div class="fw-semibold">${tt.toLocaleString('vi-VN')} ƒë</div>
          </div>`;
      }
      cartList.innerHTML = html;

      sumTotal.textContent = total.toLocaleString('vi-VN') + ' ƒë';
    } catch (err) {
      console.error('loadCart error:', err);
      cartList.innerHTML = '<div class="text-danger">Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!</div>';
      sumTotal.textContent = '0 ƒë';
    }
  }

  // ƒê·∫∑t h√†ng
  document.getElementById('btnPlaceOrder').addEventListener('click', async () => {
    const f = document.getElementById('checkoutForm');

    // Validate phone
    sanitizePhone();
    const phone = inputPhone.value;
    if (!/^[0-9]{9,12}$/.test(phone)) {
      alert('S·ªë ƒëi·ªán tho·∫°i ch·ªâ ch·ª©a s·ªë v√† ph·∫£i c√≥ 9‚Äì12 k√Ω t·ª±.');
      inputPhone.focus(); return;
    }

    // Validate date (n·∫øu c√≥ ch·ªçn)
    if (inputDate.value && inputDate.value < minDate) {
      alert('Ng√†y giao mong mu·ªën kh√¥ng ƒë∆∞·ª£c ·ªü qu√° kh·ª©.');
      inputDate.focus(); return;
    }

    const data = {
      shipping: {
        hoTen: f.hoTen.value.trim(),
        soDienThoai: phone,
        diaChi: f.diaChi.value.trim(),
        ngayGiao: inputDate.value,
        ghiChu: f.ghiChu.value.trim(),
      },
      paymentMethod: f.paymentMethod.value
    };

    if (!data.shipping.hoTen || !data.shipping.diaChi) {
      alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç t√™n v√† ƒê·ªãa ch·ªâ.');
      return;
    }

    if (buyNowId) {
      data.buyNowProductId = buyNowId;
      data.buyNowQuantity  = 1;
    }

    try {
      const res = await fetch('/api/orders/checkout', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify(data)
      });

      const js = await res.json().catch(()=> ({}));
      if (res.ok && (js.created || js.id)) {
        alert('üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!');
        const orderId = js.created || js.id;
        setTimeout(() => location.href = '/don-hang/' + orderId + '/', 1200);
      } else {
        alert('‚ùå L·ªói: ' + (js.error || res.status));
      }
    } catch (err) {
      console.error('checkout error', err);
      alert('‚ùå Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu ƒë·∫∑t h√†ng!');
    }
  });

  loadCart();
})();
</script>

{% endblock %}
