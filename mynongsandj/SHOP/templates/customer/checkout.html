{% extends "customer/base.html" %}
{% load static %}
{% block title %}ƒê·∫∑t h√†ng{% endblock %}
{% block content %}
<style>
  .checkout-cart-item{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.5rem 0;border-bottom:1px solid #e9ecef}
  .checkout-cart-item:last-child{border-bottom:none}
  .checkout-cart-item .left{display:flex;align-items:center;gap:.6rem;min-width:0}
  .checkout-cart-item .thumb{width:60px;height:60px;flex:0 0 60px;border-radius:8px;object-fit:cover;border:1px solid #dee2e6;background:#fff}
  .checkout-cart-item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px;font-weight:500}
  .card-title{font-weight:600}
  .bank-hint{background:#f6fff8;border:1px solid #cfead6;border-radius:.5rem}
  .bank-hint .input-group>.form-control{background:#fff}
  .copy-btn{white-space:nowrap}
</style>

<script src="https://js.stripe.com/v3/"></script>

<section class="py-4">
  <div class="container">
    <h2 class="h4 mb-4"><i class="bi bi-bag-check me-2"></i>ƒê·∫∑t h√†ng</h2>

    <div class="row g-4">
      <!-- LEFT -->
      <div class="col-lg-8">
        <div class="card border-success-subtle">
          <div class="card-body">
            <h5 class="card-title mb-3">Th√¥ng tin nh·∫≠n h√†ng</h5>

            <form id="checkoutForm" class="row g-3" novalidate>
              <div class="col-md-6">
                <label class="form-label">H·ªç v√† t√™n</label>
                <input name="hoTen" type="text" class="form-control" required placeholder="Nh·∫≠p h·ªç v√† t√™n">
              </div>
              <div class="col-md-6">
                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                <input name="soDienThoai" id="inputPhone" type="tel" class="form-control" required inputmode="numeric" maxlength="12" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
              </div>
              <div class="col-12">
                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                <input name="diaChi" type="text" class="form-control" required placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
              </div>
              <div class="col-12">
                <label class="form-label">Ghi ch√∫</label>
                <textarea name="ghiChu" class="form-control" rows="2" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ng√†y giao <span class="text-muted">(mong mu·ªën)</span></label>
                <input name="ngayGiao" id="ngayGiao" type="date" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                <select name="paymentMethod" id="paymentMethod" class="form-select">
                  <option value="cod" selected>COD (Thanh to√°n khi nh·∫≠n h√†ng)</option>
                  <option value="vnpay">VNPAY</option>
                  <option value="stripe">Stripe (Th·∫ª qu·ªëc t·∫ø)</option>
                </select>
              </div>

            </form>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="col-lg-4">
        <div class="card border-success-subtle">
          <div class="card-body">
            <h5 class="card-title">T·ªïng ti·ªÅn</h5>
            <div id="cartList" class="small mb-3 text-muted"></div>

            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="fw-semibold">T·ªïng ti·ªÅn</span>
              <span id="sumTotal" class="fs-5 fw-semibold">0 ƒë</span>
            </div>

            <button id="btnPlaceOrder" class="btn btn-success w-100">
              <i class="bi bi-check2-circle me-1"></i> X√°c nh·∫≠n ƒë·∫∑t h√†ng
            </button>
            <a href="/" class="btn btn-outline-success w-100 mt-2">‚Üê Ti·∫øp t·ª•c mua s·∫Øm</a>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<script>
(async () => {
  const cartList   = document.getElementById('cartList');
  const sumTotal   = document.getElementById('sumTotal');
  const paymentSel = document.getElementById('paymentMethod');
  const inputPhone = document.getElementById('inputPhone');
  const inputDate  = document.getElementById('ngayGiao');

  const urlParams = new URLSearchParams(window.location.search);
  const buyNowId = urlParams.get('buy_now');

  // Ng√†y giao kh√¥ng qu√° kh·ª©
  const todayISO = () => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  };
  const minDate = todayISO();
  inputDate.setAttribute('min', minDate);

  // ch·ªâ cho nh·∫≠p s·ªë
  inputPhone.addEventListener('input', () => {
    inputPhone.value = inputPhone.value.replace(/\D+/g, '').slice(0, 12);
  });

  const imgUrl = (p) => {
    if (!p) return '/static/img/no-image.png';
    if (p.startsWith('/') || p.startsWith('http')) return p;
    return '/media/' + p;
  };

  // Load cart
  async function loadCart() {
    try {
      let items = [];
      let total = 0;

      if (buyNowId) {
        const res = await fetch(`/api/products/${buyNowId}/`);
        const sp = await res.json();
        items.push({ ten: sp.tenSanPham, img: imgUrl(sp.hinhAnh?.[0]), sl: 1, tt: sp.gia });
        total = sp.gia;
      } else {
        const res = await fetch('/api/cart/list/', { credentials: 'same-origin' });
        const data = await res.json();
        items = data.items.map(it => ({
          ten: it.name,
          img: imgUrl(it.image),
          sl: it.qty,
          tt: it.subtotal
        }));
        total = data.total;
      }

      cartList.innerHTML = items.map(it => `
        <div class="checkout-cart-item">
          <div class="left">
            <img src="${it.img}" class="thumb">
            <div class="name">${it.ten} √ó ${it.sl}</div>
          </div>
          <div class="fw-semibold">${it.tt.toLocaleString('vi-VN')} ƒë</div>
        </div>
      `).join('');

      sumTotal.textContent = total.toLocaleString('vi-VN') + " ƒë";

    } catch (err) {
      cartList.innerHTML = '<div class="text-danger">Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!</div>';
    }
  }

  // ====== ƒê·∫∂T H√ÄNG ======
  document.getElementById("btnPlaceOrder").addEventListener("click", async () => {
    const f = document.getElementById("checkoutForm");

    if (!f.hoTen.value.trim() || !f.diaChi.value.trim()) {
      alert("Vui l√≤ng nh·∫≠p H·ªç t√™n v√† ƒê·ªãa ch·ªâ");
      return;
    }

const data = {
    shipping: {
        hoTen: f.hoTen.value.trim(),
        soDienThoai: f.soDienThoai.value.trim(),
        diaChi: f.diaChi.value.trim(),
        ngayGiao: inputDate.value,
        ghiChu: f.ghiChu.value.trim(),
    },
    paymentMethod: f.paymentMethod.value
};
if (buyNowId) {
    data.buyNowProductId = buyNowId;
    data.buyNowQuantity = 1;
}


    // g·ªçi API t·∫°o ƒë∆°n h√†ng
    const res = await fetch("/api/orders/checkout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify(data)
    });

    const js = await res.json();

    if (!res.ok) {
      alert("‚ùå L·ªói ƒë·∫∑t h√†ng!");
      return;
    }

    const orderId = js.created || js.id;

    // ‚≠ê‚≠ê‚≠ê PTTT = STRIPE
    // ‚≠ê‚≠ê‚≠ê PTTT = STRIPE (Stripe Checkout Session)
if (f.paymentMethod.value === "stripe") {

    const amount = Number(sumTotal.textContent.replace(/\D+/g, ""));

    const resp = await fetch("/create-checkout-session/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `amount=${amount}&order_id=${orderId}`
    });

    const data = await resp.json();

    if (data.url) {
        // Redirect sang trang thanh to√°n c·ªßa Stripe
        window.location.href = data.url;
    } else {
        alert("Kh√¥ng t·∫°o ƒë∆∞·ª£c phi√™n thanh to√°n Stripe!");
    }

    return;
}


    // PTTT = VNPAY
    if (f.paymentMethod.value === "vnpay") {
      window.location.href = `/payment/vnpay/create/${orderId}/`;
      return;
    }

    // PTTT = COD
    alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!");
    window.location.href = "/don-hang/" + orderId + "/";
  });

  loadCart();
})();
</script>

{% endblock %}
